---
title: JavaScript è¿›é˜¶ åä¸€ï¼š è¿­ä»£å™¨å’Œç”Ÿæˆå™¨
createTime: 2020/02/11 13:28:36
permalink: /article/wsn3vekb/
tags:
  - javascript
---

åœ¨ JavaScript çš„è¿›é˜¶ä¹‹è·¯ä¸Šï¼Œè¿­ä»£å™¨å’Œç”Ÿæˆå™¨æ˜¯ä¸¤ä¸ªéå¸¸é‡è¦ä¸”å¼ºå¤§çš„ç‰¹æ€§ã€‚å®ƒä»¬ä¸ä»…æ”¹å˜äº†æˆ‘ä»¬éå†æ•°æ®çš„æ–¹å¼ï¼Œæ›´ä¸ºå¼‚æ­¥ç¼–ç¨‹å¸¦æ¥äº†å…¨æ–°çš„æ€è·¯ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨è¿™ä¸¤ä¸ª ES6+ çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå¸®åŠ©ä½ æŒæ¡ç°ä»£ JavaScript å¼€å‘çš„å…³é”®æŠ€èƒ½ã€‚

## è¿­ä»£å™¨ï¼ˆIteratorï¼‰

### ä»€ä¹ˆæ˜¯è¿­ä»£å™¨ï¼Ÿ

è¿­ä»£å™¨æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªåºåˆ—ï¼Œå¹¶åœ¨ç»ˆæ­¢æ—¶å¯èƒ½é™„å¸¦ä¸€ä¸ªè¿”å›å€¼ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œè¿­ä»£å™¨æ˜¯é€šè¿‡ä½¿ç”¨ `next()` æ–¹æ³•å®ç°äº†**è¿­ä»£å™¨åè®®**çš„å¯¹è±¡ã€‚

:::info è¿­ä»£å™¨åè®®
è¿­ä»£å™¨åè®®è¦æ±‚å¯¹è±¡å¿…é¡»å®ç°ä¸€ä¸ª `next()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›åŒ…å«ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ï¼š

- `value`ï¼šåºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå€¼
- `done`ï¼šå¦‚æœå·²ç»è¿­ä»£åˆ°åºåˆ—ä¸­çš„æœ€åä¸€ä¸ªå€¼ï¼Œåˆ™ä¸º `true`
:::

### åŸºç¡€ç¤ºä¾‹

```javascript title="åŸºç¡€è¿­ä»£å™¨ç¤ºä¾‹"
function makeRangeIterator(start = 0, end = Infinity, step = 1) {
  let nextIndex = start
  let iterationCount = 0

  const rangeIterator = {
    next() {
      let result
      if (nextIndex < end) {
        result = { value: nextIndex, done: false }
        nextIndex += step
        iterationCount++
        return result
      }
      return { value: iterationCount, done: true }
    },
  }
  return rangeIterator
}

// ä½¿ç”¨è¿­ä»£å™¨
let it = makeRangeIterator(1, 10, 2)
let result = it.next()
while (!result.done) {
  console.log(result.value) // 1, 3, 5, 7, 9
  result = it.next()
}
console.log(`å·²è¿­ä»£åºåˆ—çš„å¤§å°ï¼š${result.value}`) // 5
```

### è¿­ä»£å™¨çš„ä»·å€¼

è¿­ä»£å™¨çš„çœŸæ­£ä»·å€¼åœ¨äºå®ƒä»¬å¯ä»¥è¡¨ç¤º**æ— é™åºåˆ—**ï¼Œè€Œæ•°ç»„å¿…é¡»å®Œæ•´åˆ†é…å†…å­˜ï¼š

```javascript title="æ— é™åºåˆ—ç¤ºä¾‹"
function* infiniteSequence() {
  let i = 0
  while (true) {
    yield i++
  }
}

const infinite = infiniteSequence()
console.log(infinite.next().value) // 0
console.log(infinite.next().value) // 1
console.log(infinite.next().value) // 2
// å¯ä»¥æ— é™ç»§ç»­...
```

## å¯è¿­ä»£å¯¹è±¡ï¼ˆIterableï¼‰

### ä»€ä¹ˆæ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Ÿ

è‹¥ä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰è¿­ä»£è¡Œä¸ºï¼ˆæ¯”å¦‚åœ¨ `for...of` ä¸­ä¼šå¾ªç¯ä¸€äº›å€¼ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ã€‚è¦å®ç°å¯è¿­ä»£ï¼Œå¯¹è±¡å¿…é¡»å®ç° `[Symbol.iterator]()` æ–¹æ³•ã€‚

:::tip å†…ç½®å¯è¿­ä»£å¯¹è±¡

- `String`ã€`Array`ã€`TypedArray`
- `Map` å’Œ `Set`
- `arguments` å¯¹è±¡
- DOM NodeList å¯¹è±¡
:::

### è‡ªå®šä¹‰å¯è¿­ä»£å¯¹è±¡

```javascript title="è‡ªå®šä¹‰å¯è¿­ä»£å¯¹è±¡"
const myIterable = {
  * [Symbol.iterator]() {
    yield 1
    yield 2
    yield 3
  },
}

// ä½¿ç”¨ for...of éå†
for (let value of myIterable) {
  console.log(value) // 1, 2, 3
}

// ä½¿ç”¨å±•å¼€è¯­æ³•
console.log([...myIterable]) // [1, 2, 3]
```

### æ–æ³¢é‚£å¥‘æ•°åˆ—è¿­ä»£å™¨

```javascript title="æ–æ³¢é‚£å¥‘æ•°åˆ—è¿­ä»£å™¨"
const fibonacci = {
  [Symbol.iterator]() {
    let pre = 0
    let cur = 1
    return {
      next() {
        [pre, cur] = [cur, pre + cur]
        return { value: cur, done: false }
      }
    }
  }
}

for (let num of fibonacci) {
  if (num > 1000)
    break
  console.log(num) // 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987
}
```

## ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰

### ä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨ï¼Ÿ

ç”Ÿæˆå™¨å‡½æ•°æ˜¯ ES6 æä¾›çš„ä¸€ç§å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆï¼Œè¯­æ³•è¡Œä¸ºä¸ä¼ ç»Ÿå‡½æ•°å®Œå…¨ä¸åŒã€‚ç”Ÿæˆå™¨å‡½æ•°ä½¿ç”¨ `function*` è¯­æ³•ç¼–å†™ã€‚

:::warning é‡è¦ç‰¹æ€§

- è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡
- ç”Ÿæˆå™¨å¯¹è±¡å®ç°äº†è¿­ä»£å™¨åè®®
- å¯ä»¥ä½¿ç”¨ `yield` å…³é”®å­—æš‚åœå‡½æ•°æ‰§è¡Œ
:::

### åŸºç¡€ç”Ÿæˆå™¨ç¤ºä¾‹

```javascript title="åŸºç¡€ç”Ÿæˆå™¨"
function* simpleGenerator() {
  yield 'Hello'
  yield 'World'
  yield '!'
}

const generator = simpleGenerator()

console.log(generator.next()) // { value: 'Hello', done: false }
console.log(generator.next()) // { value: 'World', done: false }
console.log(generator.next()) // { value: '!', done: false }
console.log(generator.next()) // { value: undefined, done: true }
```

### ä½¿ç”¨ç”Ÿæˆå™¨é‡å†™èŒƒå›´è¿­ä»£å™¨

```javascript title="ç”Ÿæˆå™¨ç‰ˆæœ¬çš„èŒƒå›´è¿­ä»£å™¨"
function* makeRangeIterator(start = 0, end = Infinity, step = 1) {
  let iterationCount = 0
  for (let i = start; i < end; i += step) {
    iterationCount++
    yield i
  }
  return iterationCount
}

const range = makeRangeIterator(1, 10, 2)
for (let value of range) {
  console.log(value) // 1, 3, 5, 7, 9
}
```

## é«˜çº§ç”Ÿæˆå™¨ç‰¹æ€§

### åŒå‘é€šä¿¡

ç”Ÿæˆå™¨æ”¯æŒåŒå‘é€šä¿¡ï¼Œå¯ä»¥é€šè¿‡ `next()` æ–¹æ³•å‘ç”Ÿæˆå™¨ä¼ é€’å€¼ï¼š

```javascript title="åŒå‘é€šä¿¡ç¤ºä¾‹"
function* twoWayGenerator() {
  const name = yield 'What is your name?'
  const age = yield `Hello ${name}, how old are you?`
  return `So you are ${age} years old, ${name}!`
}

const gen = twoWayGenerator()

console.log(gen.next().value) // "What is your name?"
console.log(gen.next('Alice').value) // "Hello Alice, how old are you?"
console.log(gen.next(25).value) // "So you are 25 years old, Alice!"
```

### é”™è¯¯å¤„ç†

ç”Ÿæˆå™¨æ”¯æŒé”™è¯¯å¤„ç†ï¼Œå¯ä»¥é€šè¿‡ `throw()` æ–¹æ³•å‘ç”Ÿæˆå™¨æŠ›å‡ºé”™è¯¯ï¼š

```javascript title="é”™è¯¯å¤„ç†ç¤ºä¾‹"
function* errorHandlingGenerator() {
  try {
    yield 'Start'
    yield 'Processing...'
    yield 'End'
  }
  catch (error) {
    yield `Caught error: ${error.message}`
  }
}

const errorGen = errorHandlingGenerator()
console.log(errorGen.next().value) // "Start"
console.log(errorGen.next().value) // "Processing..."
console.log(errorGen.throw(new Error('Something went wrong!')).value)
// "Caught error: Something went wrong!"
```

### yield* å§”æ‰˜

`yield*` è¡¨è¾¾å¼ç”¨äºå§”æ‰˜ç»™å¦ä¸€ä¸ªç”Ÿæˆå™¨æˆ–å¯è¿­ä»£å¯¹è±¡ï¼š

```javascript title="yield* å§”æ‰˜ç¤ºä¾‹"
function* generatorA() {
  yield 'A1'
  yield 'A2'
}

function* generatorB() {
  yield 'B1'
  yield* generatorA()
  yield 'B2'
}

console.log([...generatorB()]) // ['B1', 'A1', 'A2', 'B2']
```

## å®é™…åº”ç”¨åœºæ™¯

### 1. å¼‚æ­¥æµç¨‹æ§åˆ¶

åœ¨ async/await å‡ºç°ä¹‹å‰ï¼Œç”Ÿæˆå™¨æ˜¯å¤„ç†å¼‚æ­¥æ“ä½œçš„é‡è¦å·¥å…·ï¼š

```javascript title="å¼‚æ­¥æµç¨‹æ§åˆ¶"
function* asyncFlow() {
  try {
    const user = yield fetchUser()
    const posts = yield fetchUserPosts(user.id)
    const comments = yield fetchPostComments(posts[0].id)
    return { user, posts, comments }
  }
  catch (error) {
    console.error('Flow failed:', error)
  }
}

// è¿è¡Œå™¨å‡½æ•°
function runGenerator(generator) {
  const iterator = generator()

  function handle(result) {
    if (result.done)
      return Promise.resolve(result.value)

    return Promise.resolve(result.value)
      .then(res => handle(iterator.next(res)))
      .catch(err => handle(iterator.throw(err)))
  }

  try {
    return handle(iterator.next())
  }
  catch (err) {
    return Promise.reject(err)
  }
}

runGenerator(asyncFlow).then(console.log)
```

### 2. çŠ¶æ€æœº

ç”Ÿæˆå™¨éå¸¸é€‚åˆå®ç°çŠ¶æ€æœºï¼š

```javascript title="çŠ¶æ€æœºç¤ºä¾‹"
function* trafficLight() {
  while (true) {
    yield 'ğŸ”´ Red - Stop'
    yield 'ğŸŸ¡ Yellow - Prepare'
    yield 'ğŸŸ¢ Green - Go'
    yield 'ğŸŸ¡ Yellow - Slow down'
  }
}

const light = trafficLight()
console.log(light.next().value) // "ğŸ”´ Red - Stop"
console.log(light.next().value) // "ğŸŸ¡ Yellow - Prepare"
console.log(light.next().value) // "ğŸŸ¢ Green - Go"
```

### 3. æ•°æ®æµå¤„ç†

```javascript title="æ•°æ®æµå¤„ç†"
function* dataProcessor() {
  let data = yield
  while (true) {
    // å¤„ç†æ•°æ®
    data = data.toUpperCase()
    data = yield data
  }
}

const processor = dataProcessor()
processor.next() // å¯åŠ¨ç”Ÿæˆå™¨

console.log(processor.next('hello').value) // "HELLO"
console.log(processor.next('world').value) // "WORLD"
console.log(processor.next('generator').value) // "GENERATOR"
```

## æ€§èƒ½è€ƒè™‘å’Œæœ€ä½³å®è·µ

### æ€§èƒ½æç¤º

:::caution æ€§èƒ½æ³¨æ„äº‹é¡¹

1. **å†…å­˜ä½¿ç”¨**ï¼šç”Ÿæˆå™¨æŒ‰éœ€è®¡ç®—å€¼ï¼Œé€‚åˆå¤„ç†å¤§æ•°æ®é›†
2. **ä¸€æ¬¡æ€§ä½¿ç”¨**ï¼šå¤§å¤šæ•°ç”Ÿæˆå™¨åªèƒ½è¿­ä»£ä¸€æ¬¡
3. **é”™è¯¯å¤„ç†**ï¼šç¡®ä¿æ­£ç¡®å¤„ç†ç”Ÿæˆå™¨ä¸­çš„å¼‚å¸¸
:::

### æœ€ä½³å®è·µ

:::steps

- **ä½¿ç”¨åœºæ™¯åˆ¤æ–­**ï¼šåœ¨éœ€è¦æƒ°æ€§æ±‚å€¼æˆ–å¤„ç†æ— é™åºåˆ—æ—¶ä½¿ç”¨ç”Ÿæˆå™¨
- **é”™è¯¯å¤„ç†**ï¼šåœ¨ç”Ÿæˆå™¨å†…éƒ¨ä½¿ç”¨ try-catch å¤„ç†å¯èƒ½çš„é”™è¯¯
- **èµ„æºæ¸…ç†**ï¼šä½¿ç”¨ `return()` æ–¹æ³•åŠæ—¶æ¸…ç†èµ„æº
- **ä»£ç å¯è¯»æ€§**ï¼šå¯¹äºç®€å•çš„è¿­ä»£ï¼Œä¼˜å…ˆä½¿ç”¨å†…ç½®è¿­ä»£æ–¹æ³•

:::

## ç°ä»£ JavaScript ä¸­çš„è¿­ä»£å™¨å’Œç”Ÿæˆå™¨

### ä¸ async/await çš„å…³ç³»

è™½ç„¶ async/await å·²ç»æˆä¸ºå¼‚æ­¥ç¼–ç¨‹çš„ä¸»æµï¼Œä½†ç”Ÿæˆå™¨ä»ç„¶æ˜¯ç†è§£å¼‚æ­¥ç¼–ç¨‹åŸç†çš„é‡è¦åŸºç¡€ï¼š

```javascript title="ç”Ÿæˆå™¨ä¸å¼‚æ­¥å‡½æ•°å¯¹æ¯”"
// ç”Ÿæˆå™¨æ–¹å¼
function* fetchDataGenerator() {
  const user = yield fetch('/api/user')
  const posts = yield fetch('/api/posts')
  return { user, posts }
}

// async/await æ–¹å¼
async function fetchDataAsync() {
  const user = await fetch('/api/user')
  const posts = await fetch('/api/posts')
  return { user, posts }
}
```

### æœ€æ–°ç‰¹æ€§æ”¯æŒ

ç°ä»£ JavaScript ç¯å¢ƒå¯¹è¿­ä»£å™¨å’Œç”Ÿæˆå™¨æœ‰å¾ˆå¥½çš„æ”¯æŒï¼š

```javascript title="ç¯å¢ƒæ”¯æŒæ£€æŸ¥"
const supportsGenerators = function* () {}.constructor === Function
const supportsSymbol = typeof Symbol === 'function' && Symbol.iterator

console.log('Generator support:', supportsGenerators)
console.log('Symbol.iterator support:', supportsSymbol)
```

## æ€»ç»“

è¿­ä»£å™¨å’Œç”Ÿæˆå™¨æ˜¯ JavaScript ä¸­éå¸¸å¼ºå¤§çš„ç‰¹æ€§ï¼Œå®ƒä»¬ï¼š

1. **æä¾›ç»Ÿä¸€çš„è¿­ä»£æœºåˆ¶**ï¼šè®©ä¸åŒæ•°æ®ç»“æ„å¯ä»¥ä½¿ç”¨ç›¸åŒçš„éå†æ–¹å¼
2. **æ”¯æŒæƒ°æ€§æ±‚å€¼**ï¼šåªåœ¨éœ€è¦æ—¶è®¡ç®—å€¼ï¼ŒèŠ‚çœå†…å­˜
3. **ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹**ï¼šä¸º async/await å¥ å®šäº†åŸºç¡€
4. **å¢å¼ºä»£ç è¡¨è¾¾èƒ½åŠ›**ï¼šè®©å¤æ‚çš„çŠ¶æ€ç®¡ç†å’Œæ•°æ®æµå¤„ç†æ›´åŠ æ¸…æ™°

:::important å…³é”®è¦ç‚¹

- è¿­ä»£å™¨æ˜¯å®ç°äº† `next()` æ–¹æ³•çš„å¯¹è±¡
- å¯è¿­ä»£å¯¹è±¡å¿…é¡»å®ç° `[Symbol.iterator]()` æ–¹æ³•
- ç”Ÿæˆå™¨ä½¿ç”¨ `function*` å£°æ˜ï¼Œé€šè¿‡ `yield` æš‚åœæ‰§è¡Œ
- ç”Ÿæˆå™¨æ”¯æŒåŒå‘é€šä¿¡å’Œé”™è¯¯å¤„ç†
- åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåˆç†ä½¿ç”¨è¿™äº›ç‰¹æ€§å¯ä»¥æ˜¾è‘—æå‡ä»£ç è´¨é‡
:::

æŒæ¡è¿­ä»£å™¨å’Œç”Ÿæˆå™¨ï¼Œä½ å°†èƒ½å¤Ÿç¼–å†™æ›´åŠ ä¼˜é›…ã€é«˜æ•ˆçš„ JavaScript ä»£ç ï¼Œä¸ºç†è§£ç°ä»£å‰ç«¯æ¡†æ¶å’Œåº“çš„å®ç°åŸç†æ‰“ä¸‹åšå®åŸºç¡€ã€‚

## å‚è€ƒ

- [MDN è¿­ä»£å™¨å’Œç”Ÿæˆå™¨æŒ‡å—](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Iterators_and_Generators)
- [ECMAScript è§„èŒƒä¸­çš„è¿­ä»£åè®®](https://tc39.es/ecma262/#sec-iteration)
- [ç”Ÿæˆå™¨ä¸åç¨‹çš„å…³ç³»](https://en.wikipedia.org/wiki/Coroutine)
